From 125bd6b57349171176ac752e08db67de251b9d4d Mon Sep 17 00:00:00 2001
From: qubesuser <qubesuser@users.noreply.github.com>
Date: Tue, 13 Oct 2015 20:11:22 +0200
Subject: [PATCH] xen-stubdom-qubes-gui
Organization: Invisible Things Lab
Cc: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>

---
 stubdom/Makefile | 18 ++++++++++++++++--
 1 file changed, 16 insertions(+), 2 deletions(-)

diff --git a/stubdom/Makefile b/stubdom/Makefile
index 2918ee6..ad718cc 100644
--- a/stubdom/Makefile
+++ b/stubdom/Makefile
@@ -319,6 +319,11 @@ mk-headers-$(XEN_TARGET_ARCH): $(IOEMU_LINKFARM_TARGET)
 	  ln -sf $(XEN_ROOT)/tools/libxc/include/*.h . && \
 	  ln -sf $(XEN_ROOT)/tools/libxc/*.c . && \
 	  ln -sf $(XEN_ROOT)/tools/libxc/Makefile . )
+	mkdir -p vchan-$(XEN_TARGET_ARCH)
+	[ -h vchan-$(XEN_TARGET_ARCH) ] || ( cd vchan-$(XEN_TARGET_ARCH) && \
+	  ln -sf $(XEN_ROOT)/tools/vchan/*.c . && \
+	  ln -sf $(XEN_ROOT)/tools/vchan/*.h . && \
+	  ln -sf $(XEN_ROOT)/tools/vchan/Makefile.stubdom ./Makefile )
 	mkdir -p libvchan-$(XEN_TARGET_ARCH)
 	[ -h libvchan-$(XEN_TARGET_ARCH) ] || ( cd libvchan-$(XEN_TARGET_ARCH) && \
 	  ln -sf $(XEN_ROOT)/tools/libvchan/*.c . && \
@@ -354,6 +359,15 @@ libxc-$(XEN_TARGET_ARCH)/libxenctrl.a: cross-zlib
  libxc-$(XEN_TARGET_ARCH)/libxenguest.a: libxc-$(XEN_TARGET_ARCH)/libxenctrl.a
 
 #######
+# vchan
+#######
+
+.PHONY: vchan
+vchan: vchan-$(XEN_TARGET_ARCH)/libvchan.a
+vchan-$(XEN_TARGET_ARCH)/libvchan.a:
+	CPPFLAGS="$(TARGET_CPPFLAGS)" CFLAGS="$(TARGET_CFLAGS)" $(MAKE) -C vchan-$(XEN_TARGET_ARCH)
+
+#######
 # libvchan
 #######
 
@@ -445,8 +459,8 @@ xenstore: $(CROSS_ROOT)
 
 .PHONY: ioemu-stubdom
 ioemu-stubdom: APP_OBJS=$(CURDIR)/ioemu/i386-stubdom/qemu.a $(CURDIR)/ioemu/i386-stubdom/libqemu.a $(CURDIR)/ioemu/libqemu_common.a
-ioemu-stubdom: mini-os-$(XEN_TARGET_ARCH)-ioemu lwip-$(XEN_TARGET_ARCH) libxc ioemu
-	DEF_CPPFLAGS="$(TARGET_CPPFLAGS)" DEF_CFLAGS="$(TARGET_CFLAGS)" DEF_LDFLAGS="$(TARGET_LDFLAGS)" MINIOS_CONFIG="$(CURDIR)/ioemu-minios.cfg" $(MAKE) DESTDIR= -C $(MINI_OS) OBJ_DIR=$(CURDIR)/$< LWIPDIR=$(CURDIR)/lwip-$(XEN_TARGET_ARCH) APP_OBJS="$(APP_OBJS)"
+ioemu-stubdom: mini-os-$(XEN_TARGET_ARCH)-ioemu lwip-$(XEN_TARGET_ARCH) libxc ioemu vchan libvchan
+	DEF_CPPFLAGS="$(TARGET_CPPFLAGS)" DEF_CFLAGS="$(TARGET_CFLAGS)" DEF_LDFLAGS="$(TARGET_LDFLAGS)" MINIOS_CONFIG="$(CURDIR)/ioemu-minios.cfg" $(MAKE) DESTDIR= -C $(MINI_OS) OBJ_DIR=$(CURDIR)/$< LWIPDIR=$(CURDIR)/lwip-$(XEN_TARGET_ARCH) APP_OBJS="$(APP_OBJS)" vchan=y
 
 .PHONY: caml-stubdom
 caml-stubdom: mini-os-$(XEN_TARGET_ARCH)-caml lwip-$(XEN_TARGET_ARCH) libxc cross-ocaml caml
-- 
2.1.0

