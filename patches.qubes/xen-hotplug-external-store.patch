From 55b893a00c64f2fadc4caa51902a233951571de9 Mon Sep 17 00:00:00 2001
From: qubesuser <qubesuser@users.noreply.github.com>
Date: Tue, 13 Oct 2015 20:00:10 +0200
Subject: [PATCH] Use /var/run/xen-hotplug for storing information needed to
 cleanup devices. When called "remove" action - xenstore entriens can be
 already deleted.
Organization: Invisible Things Lab
Cc: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>

Signed-off-by: Marek Marczykowski <marmarek@mimuw.edu.pl>
---
 tools/hotplug/Linux/block | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/tools/hotplug/Linux/block b/tools/hotplug/Linux/block
index 2e8c017..c2d1ad3 100644
--- a/tools/hotplug/Linux/block
+++ b/tools/hotplug/Linux/block
@@ -3,6 +3,8 @@
 dir=$(dirname "$0")
 . "$dir/block-common.sh"
 
+HOTPLUG_STORE="/var/run/xen-hotplug/${XENBUS_PATH//\//-}"
+
 expand_dev() {
   local dev
   case $1 in
@@ -208,6 +210,9 @@ and so cannot be mounted ${m2}${when}."
 t=$(xenstore_read_default "$XENBUS_PATH/type" 'MISSING')
 p=$(xenstore_read "$XENBUS_PATH/params")
 mode=$(xenstore_read "$XENBUS_PATH/mode")
+echo $p > "$HOTPLUG_STORE-params"
+echo $mode > "$HOTPLUG_STORE-mode"
+echo $t > "$HOTPLUG_STORE-type"
 if [ -b "$p" ]; then
     truetype="phy"
 elif [ -f "$p" ]; then
@@ -309,6 +314,7 @@ mount it read-write in a guest domain."
           do_or_die losetup $roflag "$loopdev" "$file"
         fi
         xenstore_write "$XENBUS_PATH/node" "$loopdev"
+        echo $loopdev > "$HOTPLUG_STORE-node"
         write_dev "$loopdev"
         release_lock "block"
         exit 0
@@ -323,6 +329,7 @@ mount it read-write in a guest domain."
     ;;
 
   remove)
+    t=$(cat $HOTPLUG_STORE-type)
     case $truetype in
       phy)
 	exit 0
@@ -330,8 +337,8 @@ mount it read-write in a guest domain."
 
       file)
         claim_lock "block"
-        node=$(xenstore_read "$XENBUS_PATH/node")
-	losetup -d "$node"
+        node=$(cat "$HOTPLUG_STORE-node")
+        losetup -d "$node"
         release_lock "block"
 	exit 0
 	;;
-- 
2.1.0

